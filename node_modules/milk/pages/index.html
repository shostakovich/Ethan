<!DOCTYPE html>  <html> <head>   <title>milk.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               milk.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Milk is a simple, fast way to get more Mustache into your CoffeeScript and
Javascript.</p>

<p>Mustache templates are reasonably simple -- plain text templates are
sprinkled with "tags", which are (by default) a pair of curly braces
surrounding some bit of content. A good resource for Mustache can be found
<a href="mustache.github.com">here</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">TemplateCache</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Tags used for working with data get their data by looking up a name in a
context stack. This name corresponds to a key in a hash, and the stack is
searched top to bottom for an object with given key. Dots in names are
special: a single dot ('.') is "top of stack", and dotted names like 'a.b.c'
do a chained lookups.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Find</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span>
  <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parts</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\./</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">?</span>
    <span class="k">continue</span> <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">name</span> <span class="k">of</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">break</span>

  <span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">part</span><span class="p">,</span> <span class="p">[</span><span class="nx">value</span><span class="p">])</span> <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">parts</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If we find a function in the stack, we'll treat it as a method, and call it
with <code>this</code> bound to the element it came from. If a method returns a
function, we treat it as a lambda, which doesn't have a bound <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Function</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">do</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-&gt;</span>
      <span class="nx">val</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="o">and</span> <span class="nx">val</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">or</span> <span class="nx">val</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Null values will be coerced to the empty string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Parsed templates are expanded by simply calling each function in turn.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Expand</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span> <span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">tmpl</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>For parsing, we'll basically need a template string to parse. We do need to
remember to take the tag delimiters into account for the cache -- different
parse trees can exist for the same template string!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Parse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{{&#39;</span><span class="p">,</span><span class="s1">&#39;}}&#39;</span><span class="p">],</span> <span class="nx">section</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">cache</span> <span class="o">=</span> <span class="p">(</span><span class="nx">TemplateCache</span><span class="p">[</span><span class="nx">delimiters</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span> <span class="o">||=</span> <span class="p">{})</span>
  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">template</span><span class="p">]</span> <span class="k">if</span> <span class="nx">template</span> <span class="k">of</span> <span class="nx">cache</span>

  <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We'll use a regular expression to handle tag discovery. A proper parser
might be faster, but this is simpler, and certainly fast enough for now.
Since the tag delimiters may change over time, we'll want to rebuild the
regex when they change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">BuildRegex</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nx">tagOpen</span><span class="p">,</span> <span class="nx">tagClose</span><span class="p">]</span> <span class="o">=</span> <span class="nx">delimiters</span>
    <span class="k">return</span> <span class="err">///</span>
      <span class="p">([</span><span class="err">\</span><span class="nx">s</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">*?</span><span class="p">)</span>                <span class="c1"># Capture the pre-tag content</span>
      <span class="p">([</span><span class="c1">#{&#39; &#39;}\t]*)             # Capture the pre-tag whitespace</span>
      <span class="p">(</span><span class="o">?:</span> <span class="c1">#{tagOpen} \s*        # Match the opening tag</span>
      <span class="p">(</span><span class="o">?:</span>
        <span class="p">(</span><span class="o">!</span><span class="p">)</span>                  <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">([</span><span class="err">\</span><span class="nx">s</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">+?</span><span class="p">)</span>       <span class="o">|</span> <span class="c1"># Comments</span>
        <span class="p">(</span><span class="o">=</span><span class="p">)</span>                  <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">([</span><span class="err">\</span><span class="nx">s</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">+?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="o">=</span> <span class="o">|</span> <span class="c1"># Set Delimiters</span>
        <span class="p">({)</span>                  <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">(</span><span class="err">\</span><span class="nx">w</span><span class="p">[</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">*?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">}</span> <span class="o">|</span> <span class="c1"># Triple Mustaches</span>
        <span class="p">([</span><span class="o">^</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z</span><span class="p">.</span><span class="nx">_</span><span class="o">!=</span><span class="p">{]</span><span class="o">?</span><span class="p">)</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">([</span><span class="err">\</span><span class="nx">w</span><span class="p">.][</span><span class="err">\</span><span class="nx">S</span><span class="p">]</span><span class="o">*?</span><span class="p">)</span>      <span class="c1"># Everything else</span>
      <span class="p">)</span>
      <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="c1">#{tagClose} )         # Match the closing tag</span>
    <span class="err">///gm</span>

  <span class="nx">tagPattern</span> <span class="o">=</span> <span class="nx">BuildRegex</span><span class="p">()</span>
  <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">=</span> <span class="p">(</span><span class="nx">section</span> <span class="o">||</span> <span class="p">{</span> <span class="nv">start: </span><span class="mi">0</span> <span class="p">}).</span><span class="nx">start</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Useful errors should always be prefered - we should compile as much
relevant information as possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">parseError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">endOfLine</span> <span class="o">=</span> <span class="sr">/$/gm</span><span class="p">).</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">pos</span>
    <span class="nx">endOfLine</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>

    <span class="nx">parsedLines</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
    <span class="nx">lineNo</span>      <span class="o">=</span> <span class="nx">parsedLines</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">lastLine</span>    <span class="o">=</span> <span class="nx">parsedLines</span><span class="p">[</span><span class="nx">lineNo</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nx">tagStart</span>    <span class="o">=</span> <span class="nx">contentEnd</span> <span class="o">+</span> <span class="nx">whitespace</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">lastTag</span>     <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">tagStart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">-</span> <span class="nx">tagStart</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nx">indent</span>   <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">lastLine</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">lastTag</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nx">carets</span>   <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">lastTag</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span>
    <span class="nx">lastLine</span> <span class="o">=</span> <span class="nx">lastLine</span> <span class="o">+</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">endOfLine</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">)</span>

    <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">()</span>
    <span class="nx">error</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">e</span> <span class="o">=</span>
      <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;#{msg}\n\nLine #{lineNo}:\n#{lastLine}\n#{indent}#{carets}&quot;</span>
      <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="o">:</span> <span class="nx">indent</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="nx">lastTag</span>
    <span class="k">return</span> <span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>As we start matching things, let's pull out our captures and build indices.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">while</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">content</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="nx">tag</span>  <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">||</span> <span class="nx">match</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

    <span class="nx">contentEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">+</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nx">pos</span>        <span class="o">=</span> <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Standalone tags are tags on lines without any non-whitespace characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">isStandalone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">contentEnd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">or</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">contentEnd</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span> <span class="kc">undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We should just add static content to the buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">do</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-&gt;</span> <span class="nx">content</span><span class="p">)</span> <span class="k">if</span> <span class="nx">content</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If we're dealing with a standalone tag that's not interpolation, we
should consume the newline immediately following the tag. If we're not,
we need to buffer the whitespace we captured earlier.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">isStandalone</span> <span class="o">and</span> <span class="nx">type</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">]</span>
      <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\r&#39;</span>
      <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">whitespace</span>
      <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">do</span> <span class="p">(</span><span class="nx">whitespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">-&gt;</span> <span class="nx">whitespace</span><span class="p">)</span>
      <span class="nx">contentEnd</span> <span class="o">+=</span> <span class="nx">whitespace</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">whitespace</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Now we'll handle the tag itself:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Comment tags should simply be ignored.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;!&#39;</span> <span class="k">then</span> <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Interpolations are handled by finding the value in the context stack,
calling and rendering lambdas, and escaping the value if appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span>
        <span class="nx">buildInterpolationTag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">is_unescaped</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nb">Function</span>
              <span class="nx">value</span> <span class="o">=</span> <span class="nx">Expand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Parse</span><span class="p">(</span><span class="s2">&quot;#{value()}&quot;</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">...)</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="err">@</span><span class="nx">escape</span><span class="p">(</span><span class="s2">&quot;#{value}&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">is_unescaped</span>
            <span class="k">return</span> <span class="s2">&quot;#{value}&quot;</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buildInterpolationTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">type</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Partial data is looked up lazily by the given function, indented as
appropriate, and then rendered.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;&gt;&#39;</span>
        <span class="nx">buildPartialTag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">partials</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">partial</span> <span class="o">=</span> <span class="nx">partials</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nx">partial</span> <span class="o">=</span> <span class="nx">partial</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(?=.)/gm</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">)</span> <span class="k">if</span> <span class="nx">indentation</span>
            <span class="k">return</span> <span class="nx">Expand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">partial</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">...)</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buildPartialTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">whitespace</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Sections and Inverted Sections make a recursive parsing pass, allowing
us to use the call stack to handle section parsing. This will go until
it reaches the matching End Section tag, when it will return the
(cached!) template it parsed, along with the index it stopped at.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span>
        <span class="nx">sectionInfo</span> <span class="o">=</span>
          <span class="nv">name: </span><span class="nx">tag</span><span class="p">,</span> <span class="nv">start: </span><span class="nx">pos</span>
          <span class="nv">error: </span><span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="s2">&quot;Unclosed section &#39;#{tag}&#39;!&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="nx">tmpl</span><span class="p">,</span> <span class="nx">pos</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">delimiters</span><span class="p">,</span> <span class="nx">sectionInfo</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Sections are rendered by finding the value in the context stack,
coercing it into an array (unless the value is falsey), and rendering
the template with each element of the array taking a turn atop the
context stack. If the value was a function, the template is filtered
through it before rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">sectionInfo</span><span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buildSectionTag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">delims</span><span class="p">,</span> <span class="nx">raw</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
            <span class="nx">tmpl</span>  <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">value</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="k">else</span> <span class="nx">raw</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span>
            <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">tmpl</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span>

            <span class="nx">context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">value</span>
              <span class="nx">context</span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
              <span class="nx">Expand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...)</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

            <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Inverted Sections render under almost opposite conditions: their
contents will only be rendered when the retrieved value is either
falsey or an empty array.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">sectionInfo</span><span class="p">[</span><span class="s1">&#39;^&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buildInvertedSectionTag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">delims</span><span class="p">,</span> <span class="nx">raw</span><span class="p">)</span> <span class="o">-&gt;</span>
          <span class="k">return</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">delims</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="nx">Expand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...)</span>

        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sectionInfo</span><span class="p">[</span><span class="nx">type</span><span class="p">](</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">delimiters</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>When the parser encounters an End Section tag, it runs a couple of
quick sanity checks, then returns control back to its caller.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;/&#39;</span>
        <span class="nx">unless</span> <span class="nx">section</span><span class="o">?</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;End Section tag &#39;#{tag}&#39; found, but not in section!&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">tag</span> <span class="o">!=</span> <span class="p">(</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">section</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;End Section tag closes &#39;#{tag}&#39;; expected &#39;#{name}&#39;!&quot;</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="k">if</span> <span class="nx">error</span>

        <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">[</span><span class="nx">section</span><span class="p">.</span><span class="nx">start</span><span class="p">..</span><span class="nx">contentEnd</span><span class="p">]</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">template</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">template</span><span class="p">,</span> <span class="nx">pos</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The Set Delimiters tag needs to update the delimiters after some error
checking, and rebuild the regular expression we're using to match tags.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;=&#39;</span>
        <span class="nx">unless</span> <span class="p">(</span><span class="nx">delimiters</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;Set Delimiters tags should have two and only two values!&quot;</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="k">if</span> <span class="nx">error</span>

        <span class="nx">escape</span>     <span class="o">=</span> <span class="sr">/[-[\]{}()*+?.,\\^$|#]/g</span>
        <span class="nx">delimiters</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escape</span><span class="p">,</span> <span class="s2">&quot;\\$&amp;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">delimiters</span><span class="p">)</span>
        <span class="nx">tagPattern</span> <span class="o">=</span> <span class="nx">BuildRegex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Any other tag type is probably a typo.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span>
        <span class="k">throw</span> <span class="nx">parseError</span><span class="p">(</span><span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="s2">&quot;Unknown tag type -- #{type}&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Now that we've finished with this tag, we prepare to parse the next one!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tagPattern</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">pos</span><span class="o">?</span> <span class="k">then</span> <span class="nx">pos</span> <span class="k">else</span> <span class="nx">template</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>At this point, we've parsed all the tags.  If we've still got a <code>section</code>,
someone left a section tag open.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">throw</span> <span class="nx">section</span><span class="p">.</span><span class="nx">error</span> <span class="k">if</span> <span class="nx">section</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>All the tags is not all the content; if there's anything left over, append
it to the buffer.  Then we'll cache the buffer and return it!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">template</span><span class="p">[</span><span class="nx">pos</span><span class="p">..])</span> <span class="nx">unless</span> <span class="nx">template</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">pos</span>
  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">template</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>Public API</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The exported object (globally <code>Milk</code> in browsers) forms Milk's public API:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Milk</span> <span class="o">=</span>
  <span class="nv">VERSION: </span><span class="s1">&#39;1.2.0&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Helpers are a form of context, implicitly on the bottom of the stack. This
is a global value, and may be either an object or an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">helpers: </span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Partials may also be provided globally.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">partials: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The <code>escape</code> method performs basic content escaping, and may be either
called or overridden with an alternate escaping mechanism.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">escape: </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">entities</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">:</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">:</span> <span class="s1">&#39;quot&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;gt&#39;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&amp;&quot;&lt;&gt;]/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;&amp;#{ entities[ch] };&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Rendering is simple: given a template and some data, it populates the
template. If your template uses Partial Tags, you may also supply a hash or
a function, or simply override <code>Milk.partials</code>. There is no Step Three.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">partials</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">unless</span> <span class="p">(</span><span class="nx">partials</span> <span class="o">||=</span> <span class="err">@</span><span class="nx">partials</span> <span class="o">||</span> <span class="p">{})</span> <span class="k">instanceof</span> <span class="nb">Function</span>
      <span class="nx">partials</span> <span class="o">=</span> <span class="nx">do</span> <span class="p">(</span><span class="nx">partials</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">throw</span> <span class="s2">&quot;Unknown partial &#39;#{name}&#39;!&quot;</span> <span class="nx">unless</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">partials</span>
        <span class="k">return</span> <span class="nx">Find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">[</span><span class="nx">partials</span><span class="p">])</span>

    <span class="nx">context</span> <span class="o">=</span> <span class="k">if</span> <span class="err">@</span><span class="nx">helpers</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="k">then</span> <span class="err">@</span><span class="nx">helpers</span> <span class="k">else</span> <span class="p">[</span><span class="err">@</span><span class="nx">helpers</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">Expand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Parse</span><span class="p">(</span><span class="nx">template</span><span class="p">),</span> <span class="nx">context</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">data</span><span class="p">]),</span> <span class="nx">partials</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Happy hacking!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nx">exports</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Milk</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">Milk</span>
<span class="k">else</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">Milk</span> <span class="o">=</span> <span class="nx">Milk</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 